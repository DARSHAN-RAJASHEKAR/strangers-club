{% extends "base.html" %} {% block title %}Dashboard - Strangers Meet{% endblock
%} {% block nav_links %}
<li><a href="/app" class="hover:text-indigo-200">Dashboard</a></li>
<li><a href="#" id="logout-btn" class="hover:text-indigo-200">Logout</a></li>
{% endblock %} {% block content %}

<!-- 
  FIXED: The entire <script> block has been moved here, before the HTML that uses it.
  This ensures the app() function is defined before Alpine.js tries to call it.
-->
<script>
  function app() {
    return {
      token: "{{ token }}" || localStorage.getItem("token"),
      currentUser: null,
      groups: [],
      channels: [],
      messages: [],
      selectedGroup: null,
      selectedChannel: null,
      newMessage: "",
      loading: true,
      socket: null,
      showCreateGroupModal: false,
      showCreateChannelModal: false,
      showInviteCodeModal: false,
      inviteCode: "",
      isGroupOwner: false,
      newGroup: {
        name: "",
        description: "",
        meetup_date: null,
        is_general: false,
      },
      newChannel: {
        name: "",
        description: "",
        type: "general",
      },

      async init() {
        if (!this.token) {
          window.location.href = "/login";
          return;
        }

        // Store token in localStorage
        localStorage.setItem("token", this.token);

        try {
          // Fetch current user info
          await this.fetchCurrentUser();
          // Fetch user's groups
          await this.fetchGroups();

          // Set up logout button
          document
            .getElementById("logout-btn")
            .addEventListener("click", (e) => {
              e.preventDefault();
              this.logout();
            });
        } catch (error) {
          console.error("Initialization error:", error);
          if (error.status === 401) {
            this.logout();
          }
        } finally {
          this.loading = false;
        }
      },

      async fetchCurrentUser() {
        const response = await fetch("/api/v1/auth/me", {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok)
          throw {
            status: response.status,
            message: "Failed to fetch user data",
          };
        this.currentUser = await response.json();
      },

      async fetchGroups() {
        const response = await fetch("/api/v1/groups", {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok)
          throw { status: response.status, message: "Failed to fetch groups" };
        this.groups = await response.json();
      },

      async selectGroup(group) {
        this.selectedGroup = group;
        this.selectedChannel = null;
        this.messages = [];
        this.isGroupOwner = group.owner_id === this.currentUser.id;
        await this.fetchChannels(group.id);
      },

      async fetchChannels(groupId) {
        const response = await fetch(`/api/v1/groups/${groupId}/channels`, {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok) {
          console.error("Failed to fetch channels:", response.statusText);
          return;
        }
        this.channels = await response.json();
      },

      async selectChannel(channel) {
        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
          this.socket.close();
        }
        this.selectedChannel = channel;
        await this.fetchMessages(channel.id);
        this.setupWebSocket(channel.id);
        this.$nextTick(() => {
          const container = document.getElementById("messages-container");
          if (container) container.scrollTop = container.scrollHeight;
        });
      },

      async fetchMessages(channelId) {
        const response = await fetch(`/api/v1/messages/channel/${channelId}`, {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok) {
          console.error("Failed to fetch messages:", response.statusText);
          return;
        }
        this.messages = await response.json();
      },

      setupWebSocket(channelId) {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        this.socket = new WebSocket(
          `${protocol}//${host}/api/v1/messages/ws/${channelId}?token=${this.token}`
        );
        this.socket.onopen = () =>
          console.log("WebSocket connection established");
        this.socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === "new_message") {
            this.messages.push(data);
            this.$nextTick(() => {
              const container = document.getElementById("messages-container");
              if (container) container.scrollTop = container.scrollHeight;
            });
          }
        };
        this.socket.onclose = () => console.log("WebSocket connection closed");
        this.socket.onerror = (error) =>
          console.error("WebSocket error:", error);
      },

      async sendMessage() {
        if (!this.newMessage.trim() || !this.selectedChannel) return;
        try {
          const response = await fetch(
            `/api/v1/messages/channel/${this.selectedChannel.id}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${this.token}`,
              },
              body: JSON.stringify({ content: this.newMessage }),
            }
          );
          if (!response.ok) throw new Error("Failed to send message");
          this.newMessage = "";
        } catch (error) {
          console.error("Error sending message:", error);
          alert("Failed to send message. Please try again.");
        }
      },

      logout() {
        localStorage.removeItem("token");
        if (this.socket && this.socket.readyState === WebSocket.OPEN)
          this.socket.close();
        window.location.href = "/login";
      },
    };
  }
</script>

<div x-data="app()" x-init="init()" class="h-full flex flex-col">
  <!-- Loading state -->
  <div
    x-show="loading"
    class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-75 z-50"
  >
    <div class="text-center">
      <svg
        class="animate-spin h-10 w-10 text-indigo-600 mx-auto"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <p class="mt-2 text-indigo-600 font-medium">Loading...</p>
    </div>
  </div>

  <!-- Main UI: shown only when not loading -->
  <div
    x-show="!loading"
    class="grid grid-cols-12 gap-4 h-[calc(100vh-150px)]"
    style="display: none"
  >
    <!-- Sidebar -->
    <div class="col-span-3 bg-white rounded-lg shadow p-4 overflow-y-auto">
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Your Groups</h2>
        <div class="space-y-2">
          <template x-for="group in groups" :key="group.id">
            <a
              href="#"
              @click.prevent="selectGroup(group)"
              class="block px-3 py-2 rounded-md hover:bg-indigo-100 transition-colors"
              :class="{'bg-indigo-100': selectedGroup && selectedGroup.id === group.id}"
            >
              <span x-text="group.name" class="font-medium"></span>
            </a>
          </template>
        </div>

        <div class="mt-4">
          <button
            @click="showCreateGroupModal = true"
            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            <svg
              class="h-4 w-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              ></path>
            </svg>
            New Group
          </button>
        </div>
      </div>
      <!-- Other sidebar content... -->
    </div>

    <!-- Main content area -->
    <div class="col-span-9 bg-white rounded-lg shadow">
      <div
        x-show="!selectedChannel"
        class="h-full flex flex-col items-center justify-center p-6 text-center"
      >
        <div class="max-w-md">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            Welcome to Strangers Meet!
          </h2>
          <p class="text-gray-600 mb-6">
            Select a group and channel from the sidebar to start chatting.
          </p>
        </div>
      </div>
      <!-- Channel content shown here -->
      <div x-show="selectedChannel" class="h-full flex flex-col">
        <!-- ... Channel header, messages, input ... -->
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- This block is now intentionally empty, as the script was moved above. -->
{% endblock %}
