{% extends "base.html" %} {% block title %}Dashboard - Strangers Meet{% endblock
%} {% block nav_links %}
<li><a href="/app" class="hover:text-indigo-200">Dashboard</a></li>
<li><a href="#" id="logout-btn" class="hover:text-indigo-200">Logout</a></li>
{% endblock %} {% block content %}

<!-- 
  FIXED: The entire <script> block has been moved here, before the HTML that uses it.
  This ensures the app() function is defined before Alpine.js tries to call it.
-->
<script>
  function app() {
    return {
      token: "{{ token }}" || localStorage.getItem("token"),
      currentUser: null,
      groups: [],
      channels: [],
      messages: [],
      selectedGroup: null,
      selectedChannel: null,
      newMessage: "",
      loading: true,
      socket: null,
      showCreateGroupModal: false,
      showCreateChannelModal: false,
      showInviteCodeModal: false,
      inviteCode: "",
      isGroupOwner: false,
      newGroup: {
        name: "",
        description: "",
        meetup_date: null,
        is_general: false,
      },
      newChannel: {
        name: "",
        description: "",
        type: "general",
      },

      async init() {
        if (!this.token) {
          window.location.href = "/login";
          return;
        }

        // Store token in localStorage
        localStorage.setItem("token", this.token);

        try {
          // Fetch current user info
          await this.fetchCurrentUser();
          // Fetch user's groups
          await this.fetchGroups();

          // Set up logout button
          document
            .getElementById("logout-btn")
            .addEventListener("click", (e) => {
              e.preventDefault();
              this.logout();
            });
        } catch (error) {
          console.error("Initialization error:", error);
          if (error.status === 401) {
            this.logout();
          }
        } finally {
          this.loading = false;
        }
      },

      async fetchCurrentUser() {
        const response = await fetch("/api/v1/auth/me", {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok)
          throw {
            status: response.status,
            message: "Failed to fetch user data",
          };
        this.currentUser = await response.json();
      },

      async fetchGroups() {
        const response = await fetch("/api/v1/groups", {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok)
          throw { status: response.status, message: "Failed to fetch groups" };
        this.groups = await response.json();
      },

      async selectGroup(group) {
        this.selectedGroup = group;
        this.selectedChannel = null;
        this.messages = [];
        this.isGroupOwner = group.owner_id === this.currentUser.id;
        await this.fetchChannels(group.id);
      },

      async fetchChannels(groupId) {
        const response = await fetch(`/api/v1/groups/${groupId}/channels`, {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok) {
          console.error("Failed to fetch channels:", response.statusText);
          return;
        }
        this.channels = await response.json();
      },

      async selectChannel(channel) {
        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
          this.socket.close();
        }
        this.selectedChannel = channel;
        await this.fetchMessages(channel.id);
        this.setupWebSocket(channel.id);
        this.$nextTick(() => {
          const container = document.getElementById("messages-container");
          if (container) container.scrollTop = container.scrollHeight;
        });
      },

      async fetchMessages(channelId) {
        const response = await fetch(`/api/v1/messages/channel/${channelId}`, {
          headers: { Authorization: `Bearer ${this.token}` },
        });
        if (!response.ok) {
          console.error("Failed to fetch messages:", response.statusText);
          return;
        }
        this.messages = await response.json();
      },

      setupWebSocket(channelId) {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        this.socket = new WebSocket(
          `${protocol}//${host}/api/v1/messages/ws/${channelId}?token=${this.token}`
        );
        this.socket.onopen = () => {
          console.log(
            "WebSocket connection established for channel:",
            channelId
          );
        };
        this.socket.onmessage = (event) => {
          console.log("WebSocket message received:", event.data);
          const data = JSON.parse(event.data);
          if (data.type === "new_message") {
            // Add the message to the list
            this.messages.push(data);
            this.$nextTick(() => {
              const container = document.getElementById("messages-container");
              if (container) container.scrollTop = container.scrollHeight;
            });
          } else if (data.type === "connection_established") {
            console.log("WebSocket connection confirmed");
          }
        };
        this.socket.onclose = (event) => {
          console.log("WebSocket connection closed:", event.code, event.reason);
        };
        this.socket.onerror = (error) => {
          console.error("WebSocket error:", error);
        };
      },

      async sendMessage() {
        if (!this.newMessage.trim() || !this.selectedChannel) return;
        try {
          const response = await fetch(
            `/api/v1/messages/channel/${this.selectedChannel.id}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${this.token}`,
              },
              body: JSON.stringify({
                content: this.newMessage,
                channel_id: this.selectedChannel.id,
              }),
            }
          );
          if (!response.ok) {
            const errorData = await response.json();
            console.error("Server error:", errorData);
            throw new Error(errorData.detail || "Failed to send message");
          }

          // Get the created message from the response
          const message = await response.json();
          console.log("Message sent successfully:", message);

          // If WebSocket isn't working, manually add the message
          if (!this.socket || this.socket.readyState !== WebSocket.OPEN) {
            console.log("WebSocket not connected, adding message manually");
            // Format the message to match expected structure
            const formattedMessage = {
              id: message.id,
              content: message.content,
              author: {
                id: this.currentUser.id,
                username: this.currentUser.username,
              },
              channel_id: message.channel_id,
              created_at: message.created_at,
            };
            this.messages.push(formattedMessage);
            this.$nextTick(() => {
              const container = document.getElementById("messages-container");
              if (container) container.scrollTop = container.scrollHeight;
            });
          }

          this.newMessage = "";
        } catch (error) {
          console.error("Error sending message:", error);
          alert(`Failed to send message: ${error.message}`);
        }
      },

      async createGroup() {
        try {
          const response = await fetch("/api/v1/groups", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${this.token}`,
            },
            body: JSON.stringify(this.newGroup),
          });

          if (!response.ok) {
            throw new Error("Failed to create group");
          }

          const group = await response.json();
          this.groups.push(group);
          this.showCreateGroupModal = false;
          this.resetNewGroup();
          alert("Group created successfully!");
        } catch (error) {
          console.error("Error creating group:", error);
          alert("Failed to create group. Please try again.");
        }
      },

      async createChannel() {
        if (!this.selectedGroup) return;

        try {
          const response = await fetch(
            `/api/v1/groups/${this.selectedGroup.id}/channels`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${this.token}`,
              },
              body: JSON.stringify(this.newChannel),
            }
          );

          if (!response.ok) {
            throw new Error("Failed to create channel");
          }

          const channel = await response.json();
          this.channels.push(channel);
          this.showCreateChannelModal = false;
          this.resetNewChannel();
          alert("Channel created successfully!");
        } catch (error) {
          console.error("Error creating channel:", error);
          alert("Failed to create channel. Please try again.");
        }
      },

      async generateInviteCode() {
        if (!this.selectedGroup) return;

        try {
          const response = await fetch(
            `/api/v1/invitations/generate-new-code/${this.selectedGroup.id}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${this.token}`,
              },
            }
          );

          if (!response.ok) {
            throw new Error("Failed to generate invite code");
          }

          const invitation = await response.json();
          this.inviteCode = invitation.code;
          this.showInviteCodeModal = true;
        } catch (error) {
          console.error("Error generating invite code:", error);
          alert("Failed to generate invite code. Please try again.");
        }
      },

      copyInviteCode() {
        navigator.clipboard
          .writeText(this.inviteCode)
          .then(() => {
            alert("Invite code copied to clipboard!");
          })
          .catch(() => {
            alert("Failed to copy invite code");
          });
      },

      resetNewGroup() {
        this.newGroup = {
          name: "",
          description: "",
          meetup_date: null,
          is_general: false,
        };
      },

      resetNewChannel() {
        this.newChannel = {
          name: "",
          description: "",
          type: "general",
        };
      },

      logout() {
        localStorage.removeItem("token");
        if (this.socket && this.socket.readyState === WebSocket.OPEN)
          this.socket.close();
        window.location.href = "/login";
      },
    };
  }
</script>

<div x-data="app()" x-init="init()" class="h-full flex flex-col">
  <!-- Loading state -->
  <div
    x-show="loading"
    class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-75 z-50"
  >
    <div class="text-center">
      <svg
        class="animate-spin h-10 w-10 text-indigo-600 mx-auto"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <p class="mt-2 text-indigo-600 font-medium">Loading...</p>
    </div>
  </div>

  <!-- Main UI: shown only when not loading -->
  <div
    x-show="!loading"
    class="grid grid-cols-12 gap-4 h-[calc(100vh-150px)]"
    style="display: none"
  >
    <!-- Sidebar -->
    <div class="col-span-3 bg-white rounded-lg shadow p-4 overflow-y-auto">
      <div class="mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">Your Groups</h2>
        <div class="space-y-2">
          <template x-for="group in groups" :key="group.id">
            <a
              href="#"
              @click.prevent="selectGroup(group)"
              class="block px-3 py-2 rounded-md hover:bg-indigo-100 transition-colors"
              :class="{'bg-indigo-100': selectedGroup && selectedGroup.id === group.id}"
            >
              <span x-text="group.name" class="font-medium"></span>
            </a>
          </template>
        </div>

        <div class="mt-4">
          <button
            @click="showCreateGroupModal = true"
            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            <svg
              class="h-4 w-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6v6m0 0v6m0-6h6m-6 0H6"
              ></path>
            </svg>
            New Group
          </button>
        </div>
      </div>

      <!-- Channels section -->
      <div x-show="selectedGroup" class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-md font-semibold text-gray-700">Channels</h3>
          <button
            x-show="isGroupOwner"
            @click="showCreateChannelModal = true"
            class="text-indigo-600 hover:text-indigo-800 text-sm"
          >
            + Add
          </button>
        </div>
        <div class="space-y-1">
          <template x-for="channel in channels" :key="channel.id">
            <a
              href="#"
              @click.prevent="selectChannel(channel)"
              class="block px-2 py-1 text-sm rounded hover:bg-indigo-50 transition-colors"
              :class="{'bg-indigo-50': selectedChannel && selectedChannel.id === channel.id}"
            >
              # <span x-text="channel.name"></span>
            </a>
          </template>
        </div>

        <!-- Generate invite code button -->
        <div x-show="isGroupOwner" class="mt-4">
          <button
            @click="generateInviteCode()"
            class="inline-flex items-center px-2 py-1 border border-transparent text-xs leading-4 font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            <svg
              class="h-3 w-3 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            Invite Code
          </button>
        </div>
      </div>
    </div>

    <!-- Main content area -->
    <div class="col-span-9 bg-white rounded-lg shadow">
      <!-- Welcome message when no channel selected -->
      <div
        x-show="!selectedChannel"
        class="h-full flex flex-col items-center justify-center p-6 text-center"
      >
        <div class="max-w-md">
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            Welcome to Strangers Meet!
          </h2>
          <p class="text-gray-600 mb-6">
            Select a group and channel from the sidebar to start chatting.
          </p>
        </div>
      </div>

      <!-- Channel content -->
      <div x-show="selectedChannel" class="h-full flex flex-col">
        <!-- Channel header -->
        <div class="border-b border-gray-200 p-4">
          <h3 class="text-lg font-semibold text-gray-800">
            # <span x-text="selectedChannel ? selectedChannel.name : ''"></span>
          </h3>
          <p
            class="text-sm text-gray-600"
            x-text="selectedChannel ? selectedChannel.description : ''"
          ></p>
        </div>

        <!-- Messages area -->
        <div
          id="messages-container"
          class="flex-1 overflow-y-auto p-4 space-y-3"
        >
          <div
            x-show="messages.length === 0"
            class="text-center text-gray-500 py-8"
          >
            No messages yet. Start the conversation!
          </div>
          <template x-for="message in messages" :key="message.id">
            <div class="flex space-x-3">
              <div
                class="avatar-initial"
                x-text="message.author && message.author.username ? message.author.username.charAt(0) : 'U'"
              ></div>
              <div class="flex-1">
                <div class="flex items-baseline space-x-2">
                  <span
                    class="font-medium text-gray-900"
                    x-text="message.author && message.author.username ? message.author.username : 'Unknown User'"
                  ></span>
                  <span
                    class="text-xs text-gray-500"
                    x-text="new Date(message.created_at).toLocaleTimeString()"
                  ></span>
                </div>
                <p class="text-gray-700 mt-1" x-text="message.content"></p>
              </div>
            </div>
          </template>
        </div>

        <!-- Message input -->
        <div class="border-t border-gray-200 p-4">
          <form @submit.prevent="sendMessage" class="flex space-x-2">
            <input
              type="text"
              x-model="newMessage"
              placeholder="Type your message..."
              class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
            <button
              type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            >
              Send
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Group Modal -->
  <div
    x-show="showCreateGroupModal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
  >
    <div
      class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Group</h3>
        <form @submit.prevent="createGroup" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Group Name</label
            >
            <input
              type="text"
              x-model="newGroup.name"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Description</label
            >
            <textarea
              x-model="newGroup.description"
              rows="3"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Meetup Date (Optional)</label
            >
            <input
              type="datetime-local"
              x-model="newGroup.meetup_date"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div class="flex items-center">
            <input
              type="checkbox"
              x-model="newGroup.is_general"
              class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            />
            <label class="ml-2 block text-sm text-gray-900"
              >General Group</label
            >
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              @click="showCreateGroupModal = false; resetNewGroup()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
            >
              Create Group
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Channel Modal -->
  <div
    x-show="showCreateChannelModal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
  >
    <div
      class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4">
          Create New Channel
        </h3>
        <form @submit.prevent="createChannel" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Channel Name</label
            >
            <input
              type="text"
              x-model="newChannel.name"
              required
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Description</label
            >
            <textarea
              x-model="newChannel.description"
              rows="3"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Channel Type</label
            >
            <select
              x-model="newChannel.type"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="general">General</option>
              <option value="hobby">Hobby</option>
              <option value="interest">Interest</option>
              <option value="meetup">Meetup</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              @click="showCreateChannelModal = false; resetNewChannel()"
              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
            >
              Create Channel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Invite Code Modal -->
  <div
    x-show="showInviteCodeModal"
    class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
  >
    <div
      class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
    >
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Invitation Code</h3>
        <p class="text-sm text-gray-600 mb-4">
          Share this code with people you want to invite to the group:
        </p>
        <div class="bg-gray-100 p-3 rounded-md border">
          <code class="text-lg font-mono" x-text="inviteCode"></code>
        </div>
        <div class="flex justify-end space-x-3 pt-4">
          <button
            type="button"
            @click="copyInviteCode()"
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
          >
            Copy Code
          </button>
          <button
            type="button"
            @click="showInviteCodeModal = false"
            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<!-- This block is now intentionally empty, as the script was moved above. -->
{% endblock %}
